#!/bin/bash

## Save and export shell secrets using keychain
usage="
  Usage:
  > secret set [KEY] [VALUE]
  > secret get [KEY]
  > secret export [KEY] # outputs: export [KEY]=[VALUE]
  > secret unset [KEY]
"

MODE="$1"
KEY="$2"
VALUE="$3"
ARG_LENGTH="$#"

# Set a secret in keychain
if [ $MODE = "set" ] && [ $ARG_LENGTH -eq "3" ]; then
  if security add-generic-password -a "$USER" -s "$2" -w $VALUE -U -D "shell password";
  then echo "$KEY saved to keychain.";
  fi

# Get a secret from keychain
elif [ $MODE = "get" ] && [ $ARG_LENGTH -eq "2" ]; then
  security find-generic-password -s $KEY -w;

# Export a secret to shell
elif [ $MODE = "export" ] && [ $ARG_LENGTH -eq "2" ]; then
  if security find-generic-password -l $KEY -w &>/dev/null;
  then
    export $KEY="$(security find-generic-password -l $KEY -w)";
    echo "$KEY loaded from keychain.";
  else
    echo "$KEY not found in keychain."
  fi

# Delete a secret in keychain
elif [ $MODE = "unset" ] && [ "$#" -eq "2" ]; then
  delete-generic-password $KEY;

# Unkown paarm
else
  echo $usage;
fi

mode=$1
[ $# -eq 0 ] && { echo "Usage: $0 filename"; exit 1; }
